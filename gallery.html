<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gallery</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Gallery</h1>

  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="image" />
    <button type="submit">Upload Image</button>
  </form>

  <form id="movieForm">
    <input type="text" id="movieName" placeholder="Enter movie name" />
    <button type="submit">Add Movie</button>
  </form>

  <div id="items"></div>
  <button onclick="showMostClicked()">Result</button>

  <script>
    const socket = io();
    const itemsDiv = document.getElementById('items');

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      await fetch('/upload', { method: 'POST', body: formData });
    });

    document.getElementById('movieForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('movieName').value;
      if (!name) return;
      await fetch('/add-movie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      document.getElementById('movieName').value = '';
    });

    socket.on('update-stats', renderItems);

    function renderItems(items) {
      itemsDiv.innerHTML = '';
      items.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.style.margin = '10px';

        if (item.type === 'image') {
          const img = document.createElement('img');
          img.src = `/uploads/${item.filename}`;
          img.style.width = '100px';
          img.style.cursor = 'pointer';
          img.onclick = () => socket.emit('item-clicked', { type: 'image', key: item.filename });

          const del = document.createElement('button');
          del.textContent = 'Delete';
          del.onclick = async () => {
            await fetch(`/delete-image/${item.filename}`, { method: 'DELETE' });
          };

          wrapper.appendChild(img);
          wrapper.appendChild(document.createTextNode(` Clicks: ${item.count}`));
          wrapper.appendChild(del);
        } else if (item.type === 'movie') {
          const div = document.createElement('div');
          div.textContent = `${item.name} (Clicks: ${item.count})`;
          div.style.cursor = 'pointer';
          div.onclick = () => socket.emit('item-clicked', { type: 'movie', key: item.name });
          wrapper.appendChild(div);
        }

        itemsDiv.appendChild(wrapper);
      });
    }

    function showMostClicked() {
      fetch('/items')
        .then(res => res.json())
        .then(items => {
          let max = Math.max(...items.map(i => i.count));
          let topItems = items.filter(i => i.count === max);
          alert('Top picked:\n' + topItems.map(i => i.type === 'image' ? i.filename : i.name).join('\n'));
        });
    }
  </script>
</body>
</html>
